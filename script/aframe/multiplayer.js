/* Nodes Studio 3.0.0.1 script. 15/02/2019 */
class nodes_multiplayer{constructor(){this.data={current_id:null,last_timestamp:-1,model_position:{x:255,y:255,z:255},model_rotation:{x:255,y:255,z:255},last_upload_position:{x:255,y:255,z:255},zoom:0,fuse_click:null,submit_interval:1e3,last_submit:0,frame:0,request_time:0,ping:0},delete AFRAME.components["nodes-click"],AFRAME.registerComponent("nodes-click",{schema:{event:{default:"multiplayer.custom_function"}},init:function(){var a=this.data,b=this.el;b.addEventListener("mouseenter",function(){multiplayer.data.current_id=this.id;var c=document.getElementById("nodes_fuse").getAttribute("dur");multiplayer.data.fuse_click=setTimeout(multiplayer.fuse,c,a.event,b),document.querySelector("#cursor").emit("cursor-fusing"),document.getElementById("cursor").setAttribute("material","opacity","0.9");try{document.getElementById("model_name_"+this.id).setAttribute("opacity","1"),document.getElementById("model_select_"+this.id).setAttribute("opacity","1")}catch(a){}}),b.addEventListener("click",function(){multiplayer.fuse(a.event,b)}),b.addEventListener("mouseleave",function(){if(this.id==multiplayer.data.current_id){clearTimeout(multiplayer.data.fuse_click),multiplayer.data.current_id=null,document.querySelector("#nodes_fuse").stop(),document.querySelector("#cursor").emit("cursor-unfusing"),document.getElementById("cursor").setAttribute("material","opacity","0.1"),document.getElementById("cursor").setAttribute("material","opacity","0.1");try{document.getElementById("model_name_"+this.id).setAttribute("opacity","0"),document.getElementById("model_select_"+this.id).setAttribute("opacity","0")}catch(a){}}})}}),delete AFRAME.components["nodes-scene"],AFRAME.registerComponent("nodes-scene",{init:function(){this.el.sceneEl.addEventListener("loaded",this.load.bind(this)),multiplayer.download_data(document.querySelector("a-scene").getAttribute("nodes-lobby"))},load:function(){"connected"==this.el.getAttribute("nodes-state")?(this.el.setAttribute("nodes-state","execute"),document.querySelector("a-scene").classList.remove("loading")):this.el.setAttribute("nodes-state","autorun")}}),delete AFRAME.components["nodes-camera"],AFRAME.registerComponent("nodes-camera",{tick:function(){multiplayer.base_event(this)}}),delete AFRAME.components["nodes-terrain"],AFRAME.registerComponent("nodes-terrain",{init:function(){var a=this.el.innerHTML,b=JSON.parse(a);try{var c=1,d=THREE.ImageUtils.loadTexture(root_dir+"/img/vr/grass2.jpg");do{for(var e=new THREE.Geometry,f=0;3>f;f++)e.vertices.push(new THREE.Vector3(parseFloat(b[c][f][0]),parseFloat(b[c][f][1]),parseFloat(b[c][f][2])));var g=new THREE.Face3(0,1,2,new THREE.Vector3(0,0,0));e.faces.push(g);var h=new THREE.MeshLambertMaterial({color:16777215,map:d,side:THREE.BackSide}),i=new THREE.Mesh(e,h);this.el.object3D.add(i);for(var e=new THREE.Geometry,f=3;6>f;f++)e.vertices.push(new THREE.Vector3(parseFloat(b[c][f][0]),parseFloat(b[c][f][1]),parseFloat(b[c][f][2])));var g=new THREE.Face3(0,1,2,new THREE.Vector3(0,0,0));e.faces.push(g);var h=new THREE.MeshLambertMaterial({color:16777215,map:d,side:THREE.FrontSide}),i=new THREE.Mesh(e,h);this.el.object3D.add(i)}while(c++)}catch(a){}}}),delete AFRAME.components["nodes-trigger"],AFRAME.registerComponent("nodes-trigger",{schema:{radius:{type:"number",default:0}},tick:function(){this.data}});try{document.addEventListener("dblclick",this.click_event),document.body.addEventListener?"onwheel"in document?document.body.addEventListener("wheel",this.zooomScene):"onmousewheel"in document?document.body.addEventListener("mousewheel",this.zooomScene):document.body.addEventListener("MozMousePixelScroll",this.zooomScene):document.body.attachEvent("onmousewheel",this.zooomScene)}catch(a){}}click_event(a){null!=multiplayer.data.current_id&&document.getElementById(multiplayer.data.current_id).click(a)}base_event(a){var b=a.el.object3D.position,c=a.el.object3D.rotation,d=document.querySelector("#user_model");d.object3D.rotation.set(d.object3D.rotation.x,c.y-THREE.Math.degToRad(90),d.object3D.rotation.z);if(255==multiplayer.data.model_position.x&&255==multiplayer.data.model_position.y&&255==multiplayer.data.model_position.z&&(multiplayer.data.model_position.x=b.x,multiplayer.data.model_position.y=b.y,multiplayer.data.model_position.z=b.z),255==multiplayer.data.model_rotation.x&&255==multiplayer.data.model_rotation.y&&255==multiplayer.data.model_rotation.z&&(multiplayer.data.model_rotation.x=c.x,multiplayer.data.model_rotation.y=c.y,multiplayer.data.model_rotation.z=c.z),(c.x!=multiplayer.data.model_rotation.x||c.y!=multiplayer.data.model_rotation.y||c.z!=multiplayer.data.model_rotation.z)&&(multiplayer.data.model_rotation.x=c.x,multiplayer.data.model_rotation.y=c.y,multiplayer.data.model_rotation.z=c.z),b.x!=multiplayer.data.model_position.x||b.y!=multiplayer.data.model_position.y||b.z!=multiplayer.data.model_position.z){if(document.querySelector("#user_model").object3D.position.set(b.x,b.y-10,b.z),multiplayer.data.model_position.x=b.x,multiplayer.data.model_position.y=b.y,multiplayer.data.model_position.z=b.z,255==multiplayer.data.last_upload_position.x&&255==multiplayer.data.last_upload_position.y&&255==multiplayer.data.last_upload_position.z){var b=document.querySelector("#user_model").object3D.getWorldPosition(new THREE.Vector3);multiplayer.data.last_upload_position.x=b.x,multiplayer.data.last_upload_position.y=b.y,multiplayer.data.last_upload_position.z=b.z}try{var e=new Date().getTime();if(multiplayer.data.last_submit<e-multiplayer.data.submit_interval){multiplayer.data.last_submit=e;var b=document.querySelector("#user_model").object3D.getWorldPosition(new THREE.Vector3);if(multiplayer.data.last_upload_position.x!=b.x||multiplayer.data.last_upload_position.y!=b.y||multiplayer.data.last_upload_position.z!=b.z){multiplayer.data.last_upload_position.x=b.x,multiplayer.data.last_upload_position.y=b.y,multiplayer.data.last_upload_position.z=b.z;var f=document.getElementById("user_model").object3D.position,g=document.getElementById("rig").object3D.position,h={x:f.x+g.x,y:f.y+g.y,z:f.z+g.z},c=$id("user_model").object3D.rotation,i=$id("rig").object3D.rotation,j=parseFloat(c._x)+parseFloat(i._x),k=parseFloat(c._y)+parseFloat(i._y),l=parseFloat(c._z)+parseFloat(i._z);multiplayer.upload_data(document.querySelector("a-scene").getAttribute("nodes-lobby"),h,{x:j,y:k,z:l})}}}catch(a){console.log("Error"),console.log(a)}}}trigger(a){var b=document.getElementById("rig").object3D.position,c=document.getElementById("camera").object3D.position,d=document.getElementById(a).object3D.getWorldPosition(new THREE.Vector3),e=document.createElement("a-animation"),f={id:"move_animation_"+multiplayer.data.frame,class:"rig_animation",attribute:"position",begin:"move_object_"+multiplayer.data.frame,direction:"normal",dur:1e3,repeat:0,to:d.x+c.x+" "+b.y+" "+(d.z+c.z)};Object.keys(f).forEach(function(a){e.setAttribute(a,f[a])}),document.getElementById("rig").appendChild(e),document.getElementById("rig").emit("move_object_"+multiplayer.data.frame)}custom_function(a){console.log("Click -> "+a)}parse_data(a){var b=JSON.parse(a);if(b&&0<b.timestamp){if("load"==b.cmd){for(var c=0;c<b.count;c++)if("rig"==b.fout[c].object_id){var d=document.getElementById("rig").object3D.position,e=document.getElementById("camera").object3D.position;document.getElementById(b.fout[c].object_id).object3D.position.set(parseFloat(b.fout[c].position[0])+parseFloat(e.x),parseFloat(d.y),parseFloat(b.fout[c].position[2])+parseFloat(e.z)),document.getElementById("rig").setAttribute("rotation",b.fout[c].rotation)}else document.getElementById(b.fout[c].object_id).object3D.position.set(parseFloat(b.fout[c].position[0]),parseFloat(b.fout[c].position[1]),parseFloat(b.fout[c].position[2])),document.getElementById(b.fout[c].object_id).setAttribute("rotation",b.fout[c].rotation);}else if("action"==b.cmd)for(var c=0;c<b.count;c++){multiplayer.data.frame++;try{document.getElementById(b.fout[c].object_id).object3D.position.set(b.fout[c].position[0],b.fout[c].position[1],b.fout[c].position[2]),document.getElementById(b.fout[c].object_id).setAttribute("rotation",b.fout[c].rotation)}catch(a){}}b.timestamp>multiplayer.data.last_timestamp&&(multiplayer.data.last_timestamp=b.timestamp)}}download_data(a){try{if(0!=multiplayer.data.last_timestamp){var b=new Date,c=b.getTime();multiplayer.data.request_time=parseFloat(c),jQuery.ajax({url:root_dir+"/server.php?lobby_id="+a+"&timestamp="+multiplayer.data.last_timestamp,type:"GET",success:function(b){var c=new Date,d=c.getTime(),e=parseFloat(d)-multiplayer.data.request_time;return multiplayer.data.ping=parseInt(multiplayer.data.ping/2+e/2),b&&multiplayer.parse_data(b),"autorun"==document.querySelector("a-scene").getAttribute("nodes-state")?(console.log("Connection established"),document.querySelector("a-scene").setAttribute("nodes-state","execute"),document.querySelector("a-scene").classList.remove("loading")):"loading"==document.querySelector("a-scene").getAttribute("nodes-state")&&(document.querySelector("a-scene").setAttribute("nodes-state","connected"),console.log("Connection established")),multiplayer.download_data(a)}})}-1==multiplayer.data.last_timestamp&&(multiplayer.data.last_timestamp=0)}catch(a){}}upload_data(a,b,c){if(0!=multiplayer.data.last_timestamp)try{jQuery.ajax({url:"/server.php?lobby_id="+a+"&timestamp="+multiplayer.data.last_timestamp,data:{position:b.x+" "+b.y+" "+b.z,rotation:c.x+" "+c.y+" "+c.z},type:"POST",success:function(a){"Error"==a.substr(0,5)?alert(a):multiplayer.data.last_timestamp=a}})}catch(a){console.log(a),console.log("upload_data error")}}fuse(event,el){return eval("try{ multiplayer."+event+"(\""+el.id+"\"); }catch(e){ console.log(e); }")}zooomScene(){}}var multiplayer=new nodes_multiplayer;