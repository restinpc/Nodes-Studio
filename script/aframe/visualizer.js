var analyser,audio,frequencyData,audioContext=null,rafID=null,mediaStreamSource=null,fps=0,last_timestamp=0,color=new Array(128,128,128),order=new Array(parseInt(2*Math.random()),parseInt(2*Math.random()),parseInt(2*Math.random())),maxFrequency=new Array(0,0,0),radius=0,audio_image_id=1,opacity_interval=null,is_start=0;function rgbToHex(e){var t;function a(e){return(e.length<2?"0":"")+e}return/^rgb\(.*\)$/.test(e)?"#"+a((+(t=e.match(/\d+/g))[0]).toString(16))+a((+t[1]).toString(16))+a((+t[2]).toString(16)):e}function didntGetStream(){try{(audio=new Audio("/res/sounds/dmt.mp3")).play()}catch(e){}try{(analyser=audioContext.createAnalyser()).smoothingTimeConstant=.1,analyser.fftSize=1024,sourceNode=audioContext.createBufferSource();var e=audioContext.createMediaElementSource(audio);e.connect(analyser),e.connect(audioContext.destination),sourceNode.connect(audioContext.destination),frequencyData=new Uint8Array(analyser.frequencyBinCount),update()}catch(e){alert("error")}}function gotStream(e){mediaStreamSource=audioContext.createMediaStreamSource(e),(analyser=audioContext.createAnalyser()).fftSize=128,mediaStreamSource.connect(analyser),frequencyData=new Uint8Array(analyser.frequencyBinCount),update()}function update(){analyser.getByteFrequencyData(frequencyData),rafID=window.requestAnimationFrame(update)}function change_image(){5<++audio_image_id&&(audio_image_id=1),opacity_interval=setInterval(hide_sphere,1)}function hide_sphere(){var e=parseFloat(document.getElementById("sphere").getAttribute("opacity"));0<e?(e-=.01,document.getElementById("sphere").setAttribute("opacity",e),document.getElementById("sky").setAttribute("opacity",e)):(clearInterval(opacity_interval),document.getElementById("sphere").setAttribute("src","#equirectangular_"+audio_image_id),document.getElementById("sky").setAttribute("src","#equirectangular_"+audio_image_id),opacity_interval=setInterval(show_sphere,1))}function show_sphere(){var e=parseFloat(document.getElementById("sphere").getAttribute("opacity"));e<1?(e+=.01,document.getElementById("sphere").setAttribute("opacity",e),document.getElementById("sky").setAttribute("opacity",e)):clearInterval(opacity_interval)}function start_visualizer(){if(!is_start){is_start=1,setInterval(change_image,3e4),window.AudioContext=window.AudioContext||window.webkitAudioContext,audioContext=new AudioContext;try{navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia({audio:{optional:[{echoCancellation:!1},{mozAutoGainControl:!1},{mozNoiseSuppression:!1},{googEchoCancellation:!1},{googAutoGainControl:!1},{googNoiseSuppression:!1},{googHighpassFilter:!1}]}},gotStream,didntGetStream)}catch(e){console.log("Ошибка "+e.name+":"+e.message+"\n"+e.stack),document.getElementById("dmt").play()}}}function swap_color(){try{var e=parseInt(frequencyData[0]/maxFrequency[0]*255),t=parseInt(frequencyData[1]/maxFrequency[1]*255),a=parseInt(frequencyData[2]/maxFrequency[2]*255);document.querySelector("#sky").setAttribute("color",rgbToHex("rgb("+e+","+t+","+a+")"))}catch(e){}}delete AFRAME.components["nodes-camera"],AFRAME.registerComponent("nodes-camera",{tick:function(){last_timestamp=(0==last_timestamp||(fps=document.querySelector("a-scene").time-last_timestamp),document.querySelector("a-scene").time);try{radius=(49*radius+frequencyData[16]/10)/50,document.querySelector("#sphere").setAttribute("radius",radius)}catch(e){}var e=document.querySelector("#sky").getAttribute("rotation"),t=document.querySelector("#camera").getAttribute("rotation");document.querySelector("#sphere").setAttribute("rotation",e.x-t.x+" "+(e.y-t.y)+" "+(e.z-t.z))}}),setInterval(function(){},100);