/* Nodes Studio 3.0.0.1 script. 23/02/2019 */
var analyser,audio,frequencyData,audioContext=null,rafID=null,mediaStreamSource=null,fps=0,last_timestamp=0,color=new Array(128,128,128),radius=0,audio_image_id=1,opacity_interval=null,is_start=0;function rgbToHex(e){var t;function a(e){return(e.length<2?"0":"")+e}return/^rgb\(.*\)$/.test(e)?"#"+a((+(t=e.match(/\d+/g))[0]).toString(16))+a((+t[1]).toString(16))+a((+t[2]).toString(16)):e}function didntGetStream(){try{(audio=new Audio(root_dir+"/res/sounds/dmt.mp3")).play()}catch(e){}try{(analyser=audioContext.createAnalyser()).smoothingTimeConstant=.1,analyser.fftSize=1024,sourceNode=audioContext.createBufferSource();var e=audioContext.createMediaElementSource(audio);e.connect(analyser),e.connect(audioContext.destination),sourceNode.connect(audioContext.destination),frequencyData=new Uint8Array(analyser.frequencyBinCount),update()}catch(e){alert("error")}}function gotStream(e){mediaStreamSource=audioContext.createMediaStreamSource(e),(analyser=audioContext.createAnalyser()).fftSize=128,mediaStreamSource.connect(analyser),frequencyData=new Uint8Array(analyser.frequencyBinCount),update()}function update(){analyser.getByteFrequencyData(frequencyData),rafID=window.requestAnimationFrame(update)}function change_image(){5<++audio_image_id&&(audio_image_id=1),opacity_interval=setInterval(hide_sphere,1)}function hide_sphere(){var e=parseFloat(document.getElementById("sphere").getAttribute("opacity"));0<e?(e-=.01,document.getElementById("sphere").setAttribute("opacity",e),document.getElementById("sky").setAttribute("opacity",e)):(clearInterval(opacity_interval),document.getElementById("sphere").setAttribute("src","#equirectangular_"+audio_image_id),document.getElementById("sky").setAttribute("src","#equirectangular_"+audio_image_id),opacity_interval=setInterval(show_sphere,1))}function show_sphere(){var e=parseFloat(document.getElementById("sphere").getAttribute("opacity"));e<1?(e+=.01,document.getElementById("sphere").setAttribute("opacity",e),document.getElementById("sky").setAttribute("opacity",e)):clearInterval(opacity_interval)}function start_visualizer(){if(!is_start){is_start=1,$id("nodes_scene").enterVR(),setInterval(change_image,3e4),window.AudioContext=window.AudioContext||window.webkitAudioContext,audioContext=new AudioContext;try{navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia({audio:{optional:[{echoCancellation:!1},{mozAutoGainControl:!1},{mozNoiseSuppression:!1},{googEchoCancellation:!1},{googAutoGainControl:!1},{googNoiseSuppression:!1},{googHighpassFilter:!1}]}},gotStream,didntGetStream)}catch(e){document.getElementById("dmt").play()}}}delete AFRAME.components["nodes-camera"],AFRAME.registerComponent("nodes-camera",{tick:function(){try{for(var e=0;e<3;e++)color[e]<frequencyData[e]&&color[e]<245?color[e]+=10:color[0]>frequencyData[e]&&0<color[e]&&(color[e]-=1);var t=color[0]+color[1]+color[2],a=parseInt(color[0]/t*450),r=parseInt(color[1]/t*450),o=parseInt(color[2]/t*450);255<a&&(a=255),255<r&&(r=255),255<o&&(o=255),document.querySelector("#sky").setAttribute("color",rgbToHex("rgb("+a+","+r+","+o+")"))}catch(e){}last_timestamp=(0==last_timestamp||(fps=document.querySelector("a-scene").time-last_timestamp),document.querySelector("a-scene").time);try{(radius=(99*radius+frequencyData[128]/10)/100)<5&&(radius=5),15<radius&&(radius=15),document.querySelector("#sphere").setAttribute("radius",radius)}catch(e){}var n=document.querySelector("#sky").getAttribute("rotation"),i=document.querySelector("#camera").getAttribute("rotation");document.querySelector("#sphere").setAttribute("rotation",n.x-i.x+" "+(n.y-i.y)+" "+(n.z-i.z))}});