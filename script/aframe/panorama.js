/* Nodes Studio 3.0.0.1 script. 15/02/2019 */
var current_object=null,current_function=null,coordinates=AFRAME.utils.coordinates,isCoordinates=coordinates.isCoordinates,popup_state=0,popup_position=null,vr_load_state=0,zoom=1,object_id=0,navigation_state=1,camera_degree="",coordinates_from=null,coordinates_vr=null,mouse=new THREE.Vector2,INTERSECTED,ray=null,cubemap=null,content=null,canvas=null,scene=null,camera=null,rig=null,logo=null,move_point=null,marker=null,scene_state=0,vr_state=0;function pc_mode(e){try{$id("nodes_scene").resize()}catch(e){}setTimeout(function(){try{$id("nodes_scene").resize()}catch(e){}},0),scene_state=1,$id("cursor").setAttribute("cursor","rayOrigin","mouse"),camera.setAttribute("look-controls","reverseMouseDrag","true");for(var t=document.getElementsByClassName("custom_object"),i=0;i<t.length;i++)t[i].setAttribute("opacity","1");for(t=document.getElementsByClassName("hotpoint"),i=0;i<t.length;i++)t[i].setAttribute("opacity","1");js_hide_wnd(),marker.setAttribute("scale","0.01 0.01 0.01"),$id("fuse").setAttribute("scale","0.01 0.01 0.01"),$id("vr-block").style.display="none",$id("nodes_vr_scene").style.opacity="1",$id("vr_logo").setAttribute("opacity","1")}function mobile_mode(e){try{$id("nodes_scene").resize()}catch(e){}setTimeout(function(){try{$id("nodes_scene").resize()}catch(e){}},0),scene_state=2,canvas.style.cursor="none",$id("nodes_vr_scene").style.opacity="1",logo.setAttribute("opacity","1"),$id("vr-block").style.display="none",marker.setAttribute("material","opacity","1");for(var t=document.getElementsByClassName("custom_object"),i=0;i<t.length;i++)t[i].setAttribute("opacity","1");for(t=document.getElementsByClassName("hotpoint"),i=0;i<t.length;i++)t[i].setAttribute("opacity","1");js_hide_wnd()}function vr_mode(e){try{$id("nodes_scene").resize(e)}catch(e){}scene_state=3,mobile_mode(),scene.enterVR()}function vr_load(){if(!vr_load_state){try{ray=$id("ray"),cubemap=$id("cubemap"),content=$id("content"),canvas=document.getElementsByTagName("canvas")[0],scene=$id("nodes_scene"),camera=$id("camera"),rig=$id("rig"),logo=$id("vr_logo"),move_point=$id("move_point"),(marker=$id("marker")).setAttribute("material","opacity","0")}catch(e){console.log("Error t")}try{rotate_camera()}catch(e){console.log("Error a")}try{resize_scene(),addHandler(window,"resize",resize_scene)}catch(e){console.log("Error b")}try{canvas.addEventListener("dblclick",function(e){})}catch(e){console.log("Error c")}try{scene.addEventListener("enter-vr",function(){if(vr_state=1,3==scene_state){try{$id("sectionsNav").style.opacity="0",$id("sectionsNav").style.display="none"}catch(e){}try{$id("scene_map").style.opacity="0",$id("scene_map").style.display="none"}catch(e){}try{$id("scene_show_editor").style.opacity="0",$id("scene_show_editor").style.display="none"}catch(e){}}}),scene.addEventListener("exit-vr",function(){vr_state=0;try{$id("sectionsNav").style.opacity="1",$id("sectionsNav").style.display="block"}catch(e){}try{$id("scene_map").style.opacity="1",$id("scene_map").style.display="block"}catch(e){}try{$id("scene_show_editor").style.opacity="1",$id("scene_show_editor").style.display="block"}catch(e){}})}catch(e){console.log("Error d")}try{document.body.addEventListener?"onwheel"in document?document.body.addEventListener("wheel",zoom_scene):"onmousewheel"in document?document.body.addEventListener("mousewheel",zoom_scene):document.body.addEventListener("MozMousePixelScroll",zoom_scene):document.body.attachEvent("onmousewheel",zoom_scene)}catch(e){}var e="";800<getDocumentWidth()&&(e='<img src="/img/vr/pc.png" width=100 style="padding:10px; cursor: pointer;" title="PC" onClick=\'pc_mode(event);\'>'),show_popup_window('<b style="font-size:28px;">Instructions</b><br/><br/>\n                <div style="text-align:left; line-height: 1.6; padding-left: 10px;">Use mouse pointer or your VR headset to look around.<br/>\n                Click or focus on object up to 2 seconds to trigger it.<br/>\n                Click of focus on floor to navigate to nearest panorama.<br/>\n                </div>\n                <br/>\n                <center>\n                Please, select your device<br/><br/>\n                '+e+'<img src="/img/vr/mobile.png" width=100 style="padding:10px; cursor: pointer;" title="Smartphone" onClick=\'mobile_mode(event);\'>\n                <img src="/img/vr/vr.png" width=100 style="padding:10px; cursor: pointer;" title="Cardboard" onClick=\'vr_mode(event);\'>\n                </center>')}vr_load_state=1}function vr_click(object){try{var func=object.getAttribute("action");try{eval(func)}catch(e){}end_fuse()}catch(e){}}function show_scene_editor(){$id("add_area").style.display="block",$id("scene_editor").style.display="block",$id("scene_show_editor").style.display="none",$id("floor").setAttribute("opacity","0.1"),$id("scene_map").style.display="none"}function delete_navigation(e){confirm("Are you sure?")&&($id("action_"+e).value="delete_point",$id("object_"+e+"_form").submit())}function delete_url(e){confirm("Are you sure?")&&($id("action_"+e).value="delete_url",$id("url_"+e+"_form").submit())}function apply_changes_url(e){$id("url_"+e).setAttribute("position",$id("url_"+e+"_position").value),$id("url_"+e).setAttribute("scale",$id("url_"+e+"_scale").value)}function apply_changes_navigation(e){$id("point_"+e).setAttribute("position",$id("point_"+e+"_position").value),$id("point_"+e).setAttribute("scale",$id("point_"+e+"_scale").value)}function delete_object(e){confirm("Are you sure?")&&($id("action_"+e).value="delete_object",$id("object_"+e+"_form").submit())}function apply_changes_object(e){$id("object_"+e).setAttribute("color",$id("object_"+e+"_color").value),$id("object_"+e).setAttribute("position",$id("object_"+e+"_position").value),$id("object_"+e).setAttribute("rotation",$id("object_"+e+"_rotation").value),$id("object_"+e).setAttribute("scale",$id("object_"+e+"_scale").value)}function resize_scene(){try{$id("nodes_vr_scene").style.height=getViewportHeight()-parseInt($id("sectionsNav").clientHeight)+"px"}catch(e){}}function apply_scene_changes(){try{rig.setAttribute("position",$id("camera_position").value),rig.setAttribute("rotation",$id("camera_rotation").value),$id("floor").setAttribute("position",$id("floor_position").value),$id("floor").setAttribute("radius",$id("floor_radius").value),$id("vr_logo").setAttribute("width",$id("logo_size").value),$id("vr_logo").setAttribute("height",$id("logo_size").value)}catch(e){console.log("error f")}}function default_settings(){confirm("Are you sure you want to restore default scene configuration?")&&($id("act").name="default",$id("scene_form").submit())}function navigate(){for(var e=move_point.object3D.getWorldPosition(),t=document.getElementsByClassName("hotpoint"),i=null,o=0,r=0;r<t.length;r++){var n=t[r].object3D.getWorldPosition(),c=Math.sqrt((e.x-n.x)*(e.x-n.x)+(e.y-n.y)*(e.y-n.y)+(e.z-n.z)*(e.z-n.z));(0==o||c<o)&&(o=c,i=t[r].id)}null!=i&&"point_new_nav"!=i&&vr_click($id(i))}function zoom_scene(e){try{var t=(e=e||window.event).deltaY||e.detail||e.wheelDelta;1<t&&1<zoom?zoom-=.5:t<1&&zoom<4&&(zoom+=.5)}catch(e){}if(camera.setAttribute("zoom",zoom),1==zoom){$id("cubemap_0").setAttribute("scale","1 1 1"),$id("cubemap_1").setAttribute("scale","1.01 1.01 1.01"),$id("cubemap_2").setAttribute("scale","1.01 1.01 1.01"),$id("cubemap_3").setAttribute("scale","1.01 1.01 1.01");for(var i=0;i<$id("cubemap_1").childNodes.length;i++){var o=$id("cubemap_1").childNodes[i].id;try{$id(o).setAttribute("opacity","0")}catch(e){}}for(i=0;i<$id("cubemap_2").childNodes.length;i++){o=$id("cubemap_2").childNodes[i].id;try{$id(o).setAttribute("opacity","0")}catch(e){}}for(i=0;i<$id("cubemap_3").childNodes.length;i++){o=$id("cubemap_3").childNodes[i].id;try{$id(o).setAttribute("opacity","0")}catch(e){}}}else if(2==zoom){$id("cubemap_0").setAttribute("scale","1.01 1.01 1.01"),$id("cubemap_1").setAttribute("scale","1 1 1"),$id("cubemap_2").setAttribute("scale","1.01 1.01 1.01"),$id("cubemap_3").setAttribute("scale","1.01 1.01 1.01");for(i=0;i<$id("cubemap_1").childNodes.length;i++){o=$id("cubemap_1").childNodes[i].id;try{$id(o).setAttribute("opacity","1")}catch(e){}}for(i=0;i<$id("cubemap_2").childNodes.length;i++){o=$id("cubemap_2").childNodes[i].id;try{$id(o).setAttribute("opacity","0")}catch(e){}}for(i=0;i<$id("cubemap_3").childNodes.length;i++){o=$id("cubemap_3").childNodes[i].id;try{$id(o).setAttribute("opacity","0")}catch(e){}}}else if(3==zoom){$id("cubemap_0").setAttribute("scale","1.01 1.01 1.01"),$id("cubemap_1").setAttribute("scale","1.01 1.01 1.01"),$id("cubemap_2").setAttribute("scale","1 1 1"),$id("cubemap_3").setAttribute("scale","1.01 1.01 1.01");for(i=0;i<$id("cubemap_2").childNodes.length;i++){o=$id("cubemap_2").childNodes[i].id;try{$id(o).setAttribute("opacity","1")}catch(e){}}for(i=0;i<$id("cubemap_3").childNodes.length;i++){o=$id("cubemap_3").childNodes[i].id;try{$id(o).setAttribute("opacity","0")}catch(e){}}}else if(3<zoom){$id("cubemap_0").setAttribute("scale","1.01 1.01 1.01"),$id("cubemap_1").setAttribute("scale","1.01 1.01 1.01"),$id("cubemap_2").setAttribute("scale","1.01 1.01 1.01"),$id("cubemap_3").setAttribute("scale","1 1 1");for(i=0;i<$id("cubemap_3").childNodes.length;i++){o=$id("cubemap_3").childNodes[i].id;try{$id(o).setAttribute("opacity","1")}catch(e){}}}try{$id("nodes_scene").resize()}catch(e){}setTimeout(function(){try{$id("nodes_scene").resize()}catch(e){}},0);try{e.preventDefault?e.preventDefault():e.returnValue=!1}catch(e){}}function start_fuse(e){e!=current_object&&vr_load_state&&(current_object=e,current_function=setTimeout(function(e){vr_click(e)},2500,e),$id("fuse").emit("cursor-fusing"))}function end_fuse(){current_function&&($id("fuse").emit("cursor-stop-fusing"),$id("fuse").emit("cursor-unfusing"),clearTimeout(current_function),current_function=null)}function add_object(){marker.setAttribute("radius","0.001"),$id("fuse").setAttribute("geometry","radiusInner","0.001"),$id("fuse").setAttribute("geometry","radiusOuter","0.001"),$id("add_area").style.display="none",jQuery(".vr_object_window").css("display","none"),$id("object_new_obj").setAttribute("opacity","1"),$id("object_new_obj_window").style.display="block",object_id="new_obj"}function add_navigation(){marker.setAttribute("radius","0.001"),$id("fuse").setAttribute("geometry","radiusInner","0.001"),$id("fuse").setAttribute("geometry","radiusOuter","0.001"),$id("add_area").style.display="none",$id("point_new_nav").setAttribute("opacity","1"),$id("point_new_nav_window").style.display="block",object_id="new_nav"}function rotate_camera(){if(window.location.hash){var e=window.location.hash.replace("#","");if(e=e.split(";"),0!=parseFloat(e[0])&&0!=parseFloat(e[1])){var t="0 "+parseFloat(e[1])+" 0";try{rig.setAttribute("rotation",t)}catch(e){console.log("error j")}}}}function add_url(){marker.setAttribute("radius","0.001"),$id("fuse").setAttribute("geometry","radiusInner","0.001"),$id("fuse").setAttribute("geometry","radiusOuter","0.001"),$id("add_area").style.display="none",$id("url_new_google").setAttribute("opacity","1"),$id("url_new_google_window").style.display="block",object_id="new_google"}function show_map(e){show_popup_window('<div><iframe src="'+root_dir+"/level.php?id="+e+'" width=750 height=620></iframe></div>')}function reset_scene_object(e){confirm("Are you sure you want to remove all custom objects from this scene?")&&jQuery.ajax({type:"POST",data:{scene_reset:e},url:root_dir+"/bin.php",success:function(e){window.location.reload()}})}function load_scene(e,t){if(navigation_state){coordinates_from=null,vr_key=1,navigation_state=vr_load_state=0;try{window.history.replaceState({},"Panorama Viewer",root_dir+"/aframe/panorama/"+e)}catch(e){}if("0"!=move_point.getAttribute("opacity"))var i=move_point.object3D.getWorldPosition(new THREE.Vector3);else i=document.getElementById(t).object3D.getWorldPosition(new THREE.Vector3);move_point.setAttribute("material","opacity","0"),zoom=1,$id("camera").setAttribute("zoom",1);for(var o=0;o<$id("cubemap_1").childNodes.length;o++){var r=$id("cubemap_1").childNodes[o].id;try{$id(r).setAttribute("opacity","0"),$id(r).setAttribute("is_load","0"),$id(r).setAttribute("src","#pixel")}catch(e){}}for(o=0;o<$id("cubemap_2").childNodes.length;o++){r=$id("cubemap_2").childNodes[o].id;try{$id(r).setAttribute("opacity","0"),$id(r).setAttribute("is_load","0"),$id(r).setAttribute("src","#pixel")}catch(e){}}for(o=0;o<$id("cubemap_3").childNodes.length;o++){r=$id("cubemap_3").childNodes[o].id;try{$id(r).setAttribute("opacity","0"),$id(r).setAttribute("is_load","0"),$id(r).setAttribute("src","#pixel")}catch(e){}}var n=document.getElementById("camera").object3D.getWorldPosition(new THREE.Vector3),c=document.getElementById("rig").object3D.position;try{$id("move_animation").id=""}catch(e){}var s=document.createElement("a-animation"),a={id:"move_animation",class:"rig_animation",attribute:"position",begin:"move_rig",direction:"normal",dur:2400,repeat:0,to:(i.x+n.x)/3+" "+c.y+" "+(i.z+n.z)/3};Object.keys(a).forEach(function(e){s.setAttribute(e,a[e])}),jQuery(".vr_hidden").attr("opacity","0"),document.getElementById("rig").appendChild(s);var d=parseInt((new Date).getTime());setTimeout(function(){document.getElementById("rig").emit("move_rig"),jQuery("#vr-sound").trigger("play")},100);try{$id("scene_show_editor").style.display="none",$id("scene_editor").style.display="none",$id("add_area").style.display="none",$id("temp_data").style.display="none",$id("scene_map").style.display="none"}catch(e){}$id("virtual_scene").innerHTML="",jQuery.ajax({type:"POST",data:{scene:e},url:root_dir+"/bin.php",success:function(e){$id("temp_data").innerHTML="";var t=JSON.parse(e).children[0].children[0];$id("nodes_scene").setAttribute("scene-id",t["scene-id"]);for(var i=0;i<t.children.length;i++){var o=t.children[i];if("cubemap_0"==o.id)for(var r=0;r<t.children[i].children.length;r++)setTimeout(function(e){$id(e.id).setAttribute("src",e.src)},1,o.children[r]);else if("cubemap_1"==o.id||"cubemap_2"==o.id||"cubemap_3"==o.id)for(r=0;r<t.children[i].children.length;r++)setTimeout(function(e){$id(e.id).setAttribute("xsrc",e.xsrc),$id(e.id).setAttribute("src",e.src)},1e3-(parseInt((new Date).getTime())-d),o.children[r]);else if("virtual_scene"==o.id){var n=$id("virtual_scene");n.innerHTML="";for(var c=0;c<o.children.length;c++){var s=o.children[c],a=document.createElement(s.tag);a.id=s.id,n.appendChild(a),$.each(s,function(e,t){a.setAttribute(e,t)}),a.className+=" vr_hidden",a.setAttribute("opacity","0")}}else"floor"==o.id&&($id("floor").setAttribute("position",o.position),$id("floor").setAttribute("radius",o.radius))}setTimeout(function(){$id("rig").setAttribute("position","0 "+document.getElementById("rig").object3D.position.y+" 0"),vr_load_state=1,jQuery(".vr_hidden").attr("opacity","1"),jQuery(".hidden_layer").attr("opacity","0"),setTimeout(function(){move_point.object3D.position.set(0,.01,0),navigation_state=1},1)},2500-(parseInt((new Date).getTime())-d))}})}}delete AFRAME.components["nodes-camera"],AFRAME.registerComponent("nodes-camera",{tick:function(){if(vr_load_state){if(vr_state)try{$id("sectionsNav").style.opacity="1",$id("sectionsNav").style.display="block"}catch(e){}try{logo.object3D.rotation.y=camera.object3D.rotation.y+rig.object3D.rotation.y,(b=camera.getAttribute("rotation").x+rig.getAttribute("rotation").x+";"+(camera.getAttribute("rotation").y+rig.getAttribute("rotation").y))!=camera_degree&&(camera_degree=b,window.history.replaceState({},"Panorama Viewer",root_dir+"/aframe/panorama/"+scene.getAttribute("scene-id")+"#"+b))}catch(e){console.log("error 1")}try{if(0<scene_state){for(var e=AFRAME.scenes[0].querySelector("[raycaster]").components.raycaster,t=0,i=0,o=0,r=0;r<ray.components.raycaster.intersectedEls.length;r++){var n=ray.components.raycaster.intersectedEls[r];if("mesh load_later"==n.className){var c=n.object3D.getWorldPosition(new THREE.Vector3);if(n.getAttribute("zoom")==zoom){n.className="mesh",n.setAttribute("src",n.getAttribute("xsrc")),n.setAttribute("is_load","true");for(var s=document.getElementsByClassName("mesh load_later"),a=0;a<s.length;a++){var d=s[a];if(d.getAttribute("zoom")==zoom){var l=d.object3D.getWorldPosition(new THREE.Vector3),u=Math.sqrt((c.x-l.x)*(c.x-l.x)+(c.y-l.y)*(c.y-l.y)+(c.z-l.z)*(c.z-l.z));(zoom<3||u<500&&3==zoom||u<300)&&(setTimeout(function(e){e.className="mesh"},1e3,d),d.setAttribute("src",d.getAttribute("xsrc")),d.setAttribute("is_load","true"))}}}}}for(r=0;r<e.intersectedEls.length;r++){if("true"==e.intersectedEls[r].getAttribute("popup")){i=popup_state=1;break}if("vr_logo"==e.intersectedEls[r].id)break;if("floor"==e.intersectedEls[r].id){var _=e.intersections[r].point;move_point.object3D.position.set(_.x,_.y+.1,_.z),move_point.setAttribute("material","opacity","0.5"),o=1}if(e.intersectedEls[r].getAttribute("action")&&1<scene_state&&navigation_state)t=1,start_fuse(e.intersectedEls[r]);else if("sky_back"==e.intersectedEls[r].id&&(coordinates_vr=e.intersections[r].point,null!=coordinates_from)){var p=$id("marker").object3D.getWorldPosition(new THREE.Vector3);$id("line").setAttribute("line","end",p.x+" "+p.y+" "+p.z),$id("line").setAttribute("line","opacity","1")}}o||move_point.setAttribute("material","opacity","0.01"),t||(current_object=null,end_fuse()),!i&&popup_state&&(jQuery(".hidden_layer").attr("opacity","0"),popup_state=0)}}catch(e){console.log("error 2")}var b=camera.getAttribute("rotation"),m=$id("vr_point").object3D.getWorldPosition(new THREE.Vector3);if(0!=object_id){try{$id("point_"+object_id+"_position").value=m.x+" "+m.y+" "+m.z,$id("point_"+object_id).object3D.position.set(m.x,m.y,m.z)}catch(e){}try{$id("object_"+object_id+"_position").value=m.x+" "+m.y+" "+m.z,$id("object_"+object_id).object3D.position.set(m.x,m.y,m.z)}catch(e){}try{$id("url_"+object_id+"_position").value=m.x+" "+m.y+" "+m.z,$id("url_"+object_id).object3D.position.set(m.x,m.y,m.z)}catch(e){}}}}}),delete AFRAME.components["look-at"],AFRAME.registerComponent("look-at",{schema:{default:"",parse:function(e){return isCoordinates(e)||"object"==typeof e?coordinates.parse(e):e},stringify:function(e){return"object"==typeof e?coordinates.stringify(e):e}},init:function(){this.target3D=null,this.vector=new THREE.Vector3},update:function(){var e,t=this,i=t.data,o=t.el.object3D;return!i||"object"==typeof i&&!Object.keys(i).length?t.remove():"object"==typeof i?o.lookAt(new THREE.Vector3(i.x,i.y,i.z)):(e=t.el.sceneEl.querySelector(i))?e.hasLoaded?t.beginTracking(e):e.addEventListener("loaded",function(){t.beginTracking(e)}):void 0},tick:function(e){var t,i=this.target3D,o=this.el.object3D,r=this.vector;i&&((t=o.parent.worldToLocal(i.getWorldPosition(new THREE.Vector3))).y=o.position.y,this.el.getObject3D("camera")?r.subVectors(o.position,t).add(o.position):r=t,o.lookAt(r))},beginTracking:function(e){this.target3D=e.object3D}});